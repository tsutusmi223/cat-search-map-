<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="description" content="é¶´å²¡å¸‚å‘¨è¾ºã§ç›®æ’ƒã•ã‚ŒãŸçŒ«ã®æƒ…å ±ã‚’åœ°å›³ã§å…±æœ‰ï¼èŒ¶ãƒˆãƒ©ã€é»’çŒ«ã€ç™½çŒ«ãªã©ã®å‡ºç¾å ´æ‰€ã‚’ã¿ã‚“ãªã§è¨˜éŒ²ã—ã‚ˆã†ã€‚" />
  <meta name="keywords" content="çŒ«, é¶´å²¡, åœ°å›³, çŒ«ãƒãƒƒãƒ—, çŒ«ã®ç›®æ’ƒæƒ…å ±, cat map, tsuruoka" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç”»åƒä»˜ãåœ°å›³ã‚¢ãƒ—ãƒª</title>

  <!-- Leafletï¼ˆåœ°å›³ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼‰ -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" /> 
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase SDKï¼ˆäº’æ›ãƒ¢ãƒ¼ãƒ‰ï¼‰ -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD6bNkzZfTjj7jfZkXHcznBQanVaOgsKbI",
      authDomain: "cat-search-map-955f9.firebaseapp.com",
      projectId: "cat-search-map-955f9",
      storageBucket: "cat-search-map-955f9.appspot.com",
      messagingSenderId: "807316947292",
      appId: "1:807316947292:web:90b6bb68e0f77866c38199",
      measurementId: "G-BDKV31YP20"
    };

    // FirebaseåˆæœŸåŒ–
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <style>
    body {
  margin: 0;
  padding: 0;
  font-family: sans-serif;
  height: 100vh;
  overflow: hidden; 
}
    
    #map {
      height:100vh;
      width: 100%;
      display: none;
    }

    #fileInput {
      opacity: 0;
      position: fixed;
      top: -100px;
    }

    .popup-img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 5px 0;
      border-radius: 4px;
    }

    .delete-btn {
      background: red;
      color: white;
      border: none;
      padding: 5px 8px;
      cursor: pointer;
      border-radius: 3px;
    }

    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      max-width: 90%;
    }

    .modal-content button {
      margin-top: 15px;
      padding: 8px 16px;
      font-size: 1em;
    }

    .custom-modal {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border: 1px solid #ccc;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 10000;
      display: none;
    }
  </style>
</head>


<body>

<!-- åˆå›è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="introModal" class="modal">
  <div class="modal-content">
    <h2>ğŸ“ å†™çœŸï¼‹æ—¥æ™‚ä»˜ããƒãƒƒãƒ—</h2>
    <p>åœ°å›³ã‚’ã‚¿ãƒƒãƒ— â†’ ç”»åƒã‚’é¸æŠ â†’ ãƒ”ãƒ³ã‚’è¿½åŠ ã§ãã¾ã™ã€‚</p>
    <button onclick="closeIntro()">OK</button>
  </div>
</div>

<!-- åœ°å›³ã¨ç”»åƒé¸æŠ -->
<div id="map"></div>
<button id="selectImageBtn" style="position: fixed; top: 10px; left: 10px; z-index: 9999; display: none;">
  ğŸ“· ç”»åƒã‚’é¸ã¶
</button>
<input type="file" id="fileInput" accept="image/*" style="display: none;" />

<!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
<script>
function closeIntro() {
  document.getElementById("introModal").style.display = "none";
  setTimeout(() => {
    document.getElementById("map").style.display = "block";
    map.invalidateSize();
  }, 100);
}

const STORAGE_KEY = 'savedMarkers';

const map = L.map('map').setView([38.725213, 139.827071], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let tempLatLng = null;
const markerList = [];

function createPopupContent(data, index) {
  const { image, lat, lng, datetime } = data;
  return `
    <b>æ—¥æ™‚:</b> ${datetime || 'æœªè¨­å®š'}<br>
    <img src="${image}" class="popup-img"><br>
    <small>ç·¯åº¦: ${lat}<br>çµŒåº¦: ${lng}</small><br>
    <button class="delete-btn" onclick="deleteMarkerAt(${index})">ğŸ—‘ï¸ å‰Šé™¤</button>
  `;
}

function loadMarkersFromStorage() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (!saved) return;
  try {
    const markers = JSON.parse(saved);
    markers.forEach((data, index) => {
      if (data.image && data.image.startsWith("data:image")) {
        addMarker(data, index);
      }
    });
  } catch (e) {
    console.error("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
  }
}

function loadMarkersFromFirestore() {
  db.collection("posts").orderBy("timestamp", "desc").get().then((querySnapshot) => {
    querySnapshot.forEach((doc) => {
      const data = doc.data();
      const id = doc.id;
      const markerData = {
        lat: data.lat,
        lng: data.lng,
        datetime: data.datetime,
        image: data.image,
        id: id,
        fromFirestore: true
      };
      const index = markerList.length;
      addMarker(markerData, index);
    });
    console.log("Firestoreã‹ã‚‰æŠ•ç¨¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼");
  }).catch((error) => {
    console.error("Firestoreèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error.message);
  });
}

function saveMarkersToStorage(markers) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(markers));
}

function addMarkerToStorage(data) {
  const saved = localStorage.getItem(STORAGE_KEY);
  const markers = saved ? JSON.parse(saved) : [];
  markers.push(data);
  saveMarkersToStorage(markers);
}

function addMarker(data, index) {
  const { lat, lng } = data;
  const marker = L.marker([lat, lng]).addTo(map);
  marker.bindPopup(createPopupContent(data, index));
  marker.data = data;
  markerList[index] = marker;
}

function deleteMarker(marker, index) {
  const data = marker.data;
  if (!data || !data.id) {
    console.warn("å‰Šé™¤å¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
    return;
  }

  map.removeLayer(marker);
  markerList.splice(index, 1);

  const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  const savedIndex = saved.findIndex(item => item.id === data.id);
  if (savedIndex !== -1) {
    saved.splice(savedIndex, 1);
    saveMarkersToStorage(saved);
  }

  db.collection("posts").doc(data.id).delete().then(() => {
    console.log("Firestoreã‹ã‚‰ã‚‚å‰Šé™¤ã—ã¾ã—ãŸ: ", data.id);
    loadMarkersFromFirestore();
  }).catch((error) => {
    console.error("Firestoreå‰Šé™¤ã‚¨ãƒ©ãƒ¼:", error.message);
  });
}

window.deleteMarkerAt = function (index) {
  const marker = markerList[index];
  if (!marker) return;
  if (confirm("ã“ã®ãƒ”ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
    deleteMarker(marker, index);
  }
};

map.on('click', function (e) {
  tempLatLng = e.latlng;
  selectImageBtn.style.display = 'block';
});

const selectImageBtn = document.getElementById('selectImageBtn');
selectImageBtn.onclick = () => {
  document.getElementById('fileInput').click();
};

document.getElementById('fileInput').addEventListener('change', function () {
  const file = this.files[0];
  if (!file || !tempLatLng) return;
  if (!file.type.startsWith("image/")) {
    alert("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚");
    return;
  }

  const reader = new FileReader();
  reader.onload = function (event) {
    const imageData = event.target.result;
    if (!imageData) {
      alert("ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      return;
    }

    const datetime = getCurrentDateTime();
    const lat = parseFloat(tempLatLng.lat.toFixed(6));
    const lng = parseFloat(tempLatLng.lng.toFixed(6));
    const id = Date.now().toString();
    const newData = {
      lat,
      lng,
      image: imageData,
      datetime,
      id
    };
    const index = markerList.length;
    addMarkerToStorage(newData);
    addMarker(newData, index);
    db.collection("posts").doc(id).set({
      id,
      lat,
      lng,
      datetime,
      image: imageData,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    document.getElementById("fileInput").value = '';
    tempLatLng = null;
  };
  reader.readAsDataURL(file);
});

function getCurrentDateTime() {
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  const hh = String(d.getHours()).padStart(2, '0');
  const min = String(d.getMinutes()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd} ${hh}:${min}`;
}

// åˆæœŸèª­ã¿è¾¼ã¿
loadMarkersFromStorage();
loadMarkersFromFirestore();
</script>
</body>
</html>


